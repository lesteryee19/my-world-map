<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„å…¨çƒè»äº‹éƒ¨ç½²åœ°åœ–</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft JhengHei", sans-serif; background-color: #f4f4f4; }
        header { background: #1a1a1a; color: white; padding: 15px; text-align: center; border-bottom: 3px solid #c0392b; }
        #map { height: 75vh; width: 98%; margin: 10px auto; border: 2px solid #333; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .controls { text-align: center; margin: 10px; }
        button { 
            padding: 8px 16px; 
            margin: 0 5px;
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold;
        }
        .btn-clear { background-color: #e74c3c; }
        .btn-import { background-color: #3498db; }
        .btn-clear:hover { background-color: #c0392b; }
        .btn-import:hover { background-color: #2980b9; }
        .popup-military { color: #c0392b; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <h1>å…¨çƒè»äº‹éƒ¨ç½²èˆ‡å€‹äººæ¨™è¨˜åœ°åœ–</h1>
    </header>

    <div class="controls">
        <button class="btn-clear" onclick="clearMap()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ¨™è¨˜</button>
        <input type="file" id="fileInput" accept=".json" style="display:none">
        <button class="btn-import" onclick="document.getElementById('fileInput').click()">ğŸ“‚ åŒ¯å…¥ JSON æ•¸æ“š</button>
        <p style="font-size: 0.85em; color: #666;">æç¤ºï¼šé»æ“Šåœ°åœ–æ–°å¢å€‹äººæ¨™è¨˜ï¼›è‡ªå‹•è®€å–åŒè³‡æ–™å¤¾ä¸‹çš„ military.json æª”æ¡ˆ</p>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // 1. åˆå§‹åŒ–åœ°åœ–ï¼šè¨­å®šã€Œå–®ä¸€åœ°çƒã€å¾ªç’°
        const map = L.map('map', {
            worldCopyJump: true,      // å¾€å·¦/å³æ»‘å‹•æ™‚è‡ªå‹•è·³è½‰å›åŸé»ï¼Œå¯¦ç¾ç„¡é™å¾ªç’°
            center: [20, 0],          
            zoom: 2,                  
            minZoom: 2,               // é™åˆ¶æœ€å°ç¸®æ”¾ï¼Œé¿å…çœ‹åˆ°é‡è¤‡çš„ä¸–ç•Œ
            maxBoundsViscosity: 0.5
        });

        // 2. è¼‰å…¥ç°¡æ½”çš„åº•åœ– (CartoDB Positron - é¡ä¼¼ Google Maps é¢¨æ ¼)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }).addTo(map);

        // --- åŠŸèƒ½ A: å€‹äººæ¨™è¨˜ (LocalStorage) ---
        let savedLocations = JSON.parse(localStorage.getItem('my_map_marks')) || [];

        // ç•«å‡ºåŸæœ¬å­˜å¥½çš„é»
        savedLocations.forEach(loc => {
            L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(loc.text);
        });

        // é»æ“Šæ–°å¢æ¨™è¨˜
        map.on('click', function(e) {
            const text = prompt("è«‹è¼¸å…¥æ­¤åœ°é»çš„å‚™è¨»ï¼š");
            if (text) {
                L.marker(e.latlng).addTo(map).bindPopup(text).openPopup();
                const newLoc = { lat: e.latlng.lat, lng: e.latlng.lng, text: text };
                savedLocations.push(newLoc);
                localStorage.setItem('my_map_marks', JSON.stringify(savedLocations));
            }
        });

        // --- åŠŸèƒ½ B: è‡ªå‹•è®€å–è»äº‹æ•¸æ“š (military.json) ---
        fetch('military.json')
            .then(response => response.json())
            .then(data => {
                data.forEach(unit => {
                    // ä½¿ç”¨é è¨­åœ–é‡˜ï¼Œä½†å…§å®¹è¨­å®šç‚ºè»äº‹é¢¨æ ¼
                    const marker = L.marker([unit.lat, unit.lng]).addTo(map);
                    const content = `
                        <div class="popup-military">[${unit.type}]</div>
                        <strong>${unit.name}</strong><br>
                        ç‹€æ…‹: ${unit.status}<br>
                        ${unit.description}
                    `;
                    marker.bindPopup(content);
                });
                console.log("è»äº‹æ•¸æ“šåŠ è¼‰æˆåŠŸ");
            })
            .catch(err => console.log("ç›®å‰æ²’æœ‰æ‰¾åˆ° military.json æª”æ¡ˆ"));

        // --- åŠŸèƒ½ C: åŒ¯å…¥èˆ‡æ¸…é™¤ ---
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    data.forEach(loc => {
                        L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(loc.text);
                        savedLocations.push(loc);
                    });
                    localStorage.setItem('my_map_marks', JSON.stringify(savedLocations));
                    alert("åŒ¯å…¥æˆåŠŸï¼");
                } catch (err) {
                    alert("JSON æ ¼å¼ä¸æ­£ç¢º");
                }
            };
            reader.readAsText(file);
        });

        function clearMap() {
            if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰æ¨™è¨˜å—ï¼Ÿ")) {
                localStorage.removeItem('my_map_marks');
                location.reload();
            }
        }
    </script>
</body>
</html>